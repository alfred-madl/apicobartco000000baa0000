{%- comment %} ================================= Transform OpenAPI to Azure Function App proxies.json ============================================= {% endcomment -%}
{% if site.time == nil -%}
{% assign pths = paths -%}
{% assign xapicoinfo = x-apico-info -%}
{% assign inf = info -%}
{% assign srvs = servers -%}
{% else -%}
{% assign pths = site.data.openapi.paths -%}
{% assign xapicoinfo = site.data.openapi.x-apico-info -%}
{% assign inf = site.data.openapi.info -%}
{% assign srvs = site.data.openapi.servers -%}
{% endif -%}
{% assign parts = srvs[0].url | split: "/" -%}
{% assign prt = parts[0] | remove: ":" -%}
{% assign hst = parts[2] -%}
{% assign pth =  srvs[0].url | remove_first: prt | remove_first: "://" | remove_first: hst -%}
{
    "$schema": "http://json.schemastore.org/proxies",
    "proxies": {
        {%- comment %} ================================= Fixed Proxies ============================================= {% endcomment %}
        {%- comment %}
        "directory_signup": {
            "desc": [
                "Browser URL to the entry point to signup a new B2C user"
            ],
            "matchCondition": {
                "route": "/directory/signup",
                "methods": [
                    "GET"
                ]
            },
            "responseOverrides": {
                "response.statusCode": "302",
                "response.headers.Location": "https://apicousers.b2clogin.com/users.apico.io/oauth2/v2.0/authorize?p=B2C_1_signupv1&client_id=7bb74417-4206-45f7-b796-b82ba6ebe89e&nonce=defaultNonce&redirect_uri=https%3A%2F%2Fapi.apico.io%2Fdirectory%2Fsignedup&scope=openid&response_type=id_token&prompt=login",
                "response.body": "Redirecting..."
            }
        },
        "directory_signedup": {
            "desc": [
                "Browser URL for the signup callback, if it contains the word error then the user canceled the signup and we should redirect back to the homepage, otherwise we should redirect to the webapp"
            ],
            "matchCondition": {
                "route": "/directory/signedup",
                "methods": [
                    "GET"
                ]
            },
            "responseOverrides": {
                "response.statusCode": "302",
                "response.headers.Location": "https://webapp.apico.io",
                "response.body": "Redirecting..."
            }
        },
        "webapp_start": {
            "desc": [
                "Browser URL to the entry point to redirect to show the latest version of the main form of the latest version of the webapp for the users default tenant, usually in the green slot",
                "should be e.g. https://api.apico.io/webapp/start and redirect e.g. to https://webapp.apico.io/v1/index.html in production",
                "should be e.g. http://api.grn.mav.cod.plg.dev.apico.io/webapp/start and redirect e.g. to http://webapp.grn.mav.cod.plg.dev.apico.io/v1 in development"
            ],
            "matchCondition": {
                "route": "/webapp/start",
                "methods": [
                    "GET"
                ]
            },
            "responseOverrides": {
                "response.statusCode": "302",
                "response.headers.Location": "https://www.google.com",
                "response.body": "Redirecting..."
            }
        },
        "root": {
            "desc": [
                "Browser URL to the entry point to redirect to show the latest version of the API documentation, should be swagger ?"
            ],
            "matchCondition": {
                "route": "/",
                "methods": [
                    "GET"
                ]
            },
            "responseOverrides": {
                "response.statusCode": "302",
                "response.headers.Location": "https://www.apico.io",
                "response.body": "Redirecting..."
            }
        },
        {%- endcomment %}
        {%- comment %} ================================= Special chars ============================================= {% endcomment -%}
        {%- assign a = "{" -%}
        {%- assign aa = "{{" -%}
        {%- assign bb = "}}" -%} 
        {%- assign b = "}" -%} 
        {%- assign c = "/" -%}
        {%- assign d = "'" -%}
        {%- for path in pths %}{% for method in path[1] %}
        {%- if method[0]=="get" or method[0]=="put" or method[0]=="post" or method[0]=="delete" or method[0]=="options" or method[0]=="head" or method[0]=="patch" or method[0]=="trace" %}
        {%- comment %} ================================= Proxy name ============================================= {% endcomment %}
        "{{ pth | replace_first: "/", "" | replace: "/", "_" -}}
            {{- path[0] | replace: "(", "_" | remove: a | remove: ")" | remove: b | remove: d | remove: "-" | replace: c, "_" | downcase -}}
            {% if path[0] == "/" %}root{% endif %}_{{ method[0] }}": {
            {%- comment %} ================================= Proxy description ============================================= {% endcomment %}
            "desc": [
                "{{ method[1].description }}"
            ],
            "matchCondition": {
                "route": "{{ pth }}{{ path[0] }}",
                "methods": [
                    "{{ method[0] | upcase }}"
                ]
            },
            {%- comment %} ================================= Proxy backend url ============================================= {% endcomment %}
            "backendUri": "https://%x-apico-operation-url-
            {%- assign reverse =  path[0] | split: "" | reverse -%}
            {% assign last = reverse[0] -%}
            {%- if method[0]=="get" and last==")" %}read
                {%- elsif method[0]=="get" %}list
                {%- else %}command
            {%- endif %}%",                
            {%- comment %} ================================= Proxy overrides ============================================= {% endcomment %}
            "requestOverrides": {
                "backend.request.headers.x-apico-proxy-template-version": "1",
                "backend.request.headers.x-apico-api-version": "{{ inf.version }}",
                "backend.request.method": "POST",
                "backend.request.headers.Authorization": "",
                "backend.request.headers.x-apico-request-method": "{request.method}",
                "backend.request.headers.x-apico-request-headers-Authorization": "{request.headers.Authorization}",
                "backend.request.headers.x-apico-request-headers-Host": "{request.headers.Host}",
                "backend.request.headers.x-apico-request-headers-CLIENT-IP": "{request.headers.CLIENT-IP}"            
                "backend.request.headers.x-apico-server-url": "{{ srvs[0].url }}",
                "backend.request.headers.x-apico-path": "{{ path[0] }}",
                "backend.request.headers.x-apico-proxy-route": "{{ path[0] | replace: a, aa | replace: b, bb }}",
                "backend.request.headers.x-apico-operation-id": "{{ method[1].operationId }}"
            {%- comment %} ================================= All these settings following should got to APp Sett9imgs of the Logic App ============================================= 
                "backend.request.headers.x-apico-tenant-code": "%x-apico-tenant-code%",
                "backend.request.headers.x-apico-tenant-name": "%x-apico-tenant-name%",
                "backend.request.headers.x-apico-tenant-key": "%x-apico-tenant-key%",
                "backend.request.headers.x-apico-set-code": "%x-apico-set-code%",
                "backend.request.headers.x-apico-set-name": "%x-apico-set-name%",
                "backend.request.headers.x-apico-set-key": "%x-apico-set-key%",
                "backend.request.headers.x-apico-set-domain": "%x-apico-set-domain%",
                "backend.request.headers.x-apico-project-code": "%x-apico-project-code%",
                "backend.request.headers.x-apico-project-name": "%x-apico-project-name%",
                "backend.request.headers.x-apico-project-key": "%x-apico-project-key%",
                "backend.request.headers.x-apico-project-sub-domain": "%x-apico-project-sub-domain%",
                "backend.request.headers.x-apico-service-code": "%x-apico-service-code%",
                "backend.request.headers.x-apico-service-name": "%x-apico-service-name%",
                "backend.request.headers.x-apico-service-key": "%x-apico-service-key%",
                "backend.request.headers.x-apico-version-code": "%x-apico-version-code%",
                "backend.request.headers.x-apico-version-name": "%x-apico-version-name%",
                "backend.request.headers.x-apico-version-key": "%x-apico-version-key%",
                "backend.request.headers.x-apico-version-number": "%x-apico-version-number%",
                "backend.request.headers.x-apico-version-path": "%x-apico-version-path%",
                "backend.request.headers.x-apico-generation-id": "%x-apico-generation-id%",
                "backend.request.headers.x-apico-generation-wt": "%x-apico-generation-wt%",
                "backend.request.headers.x-apico-generation-template": "%x-apico-generation-template%",
                "backend.request.headers.x-apico-deployment-id": "%x-apico-deployment-id%",
                "backend.request.headers.x-apico-deployment-wt":"%x-apico-deployment-wt%",
                "backend.request.headers.x-apico-family-code": "%x-apico-family-code%",
                "backend.request.headers.x-apico-family-name": "%x-apico-family-codename
                "backend.request.headers.x-apico-family-key": "%x-apico-family-key%",
                "backend.request.headers.x-apico-lane-code": "%x-apico-lane-code%",
                "backend.request.headers.x-apico-lane-name": "%x-apico-lane-name%",
                "backend.request.headers.x-apico-lane-key": "%x-apico-lane-key%",
                "backend.request.headers.x-apico-slot-code": "%x-apico-slot-code%",
                "backend.request.headers.x-apico-slot-name": "%x-apico-slot-name%",
                "backend.request.headers.x-apico-slot-key": "%x-apico-slot-key%",
                "backend.request.headers.x-apico-environment-code": "%x-apico-environment-code%",
                "backend.request.headers.x-apico-environment-name": "%x-apico-environment-name%",
                "backend.request.headers.x-apico-environment-key": "%x-apico-environment-key%",
                "backend.request.headers.x-apico-region-code": "%x-apico-region-code%",
                "backend.request.headers.x-apico-region-name": "%x-apico-region-name%",
                "backend.request.headers.x-apico-region-key": "%x-apico-region-key%"
                {% endcomment %}
            }
        }
        {%- if forloop.last == false -%},{% endif -%}
        {% endif -%}
        {% endfor -%}
        {% if forloop.last == false -%},{% endif -%}
        {% endfor %}
    }
}