{%- comment %} ================================= Transform OpenAPI to Azure Function App proxies.json ============================================= {% endcomment -%}
{% if site.time == nil -%}
{% assign pths = paths -%}
{% assign xapicoinfo = x-apico-info -%}
{% assign inf = info -%}
{% assign srvs = servers -%}
{% else -%}
{% assign pths = site.data.openapi.paths -%}
{% assign xapicoinfo = site.data.openapi.x-apico-info -%}
{% assign inf = site.data.openapi.info -%}
{% assign srvs = site.data.openapi.servers -%}
{% endif -%}
{% assign parts = srvs[0].url | split: "/" -%}
{% assign prt = parts[0] | remove: ":" -%}
{% assign hst = parts[2] -%}
{% assign pth =  srvs[0].url | remove_first: prt | remove_first: "://" | remove_first: hst -%}
{
    "$schema": "http://json.schemastore.org/proxies",
    "proxies": {
        {%- assign a = "{" -%}
        {%- assign aa = "{{" -%}
        {%- assign bb = "}}" -%} 
        {%- assign b = "}" -%} 
        {%- assign c = "/" -%}
        {%- assign d = "'" -%}
        {%- for path in pths %}{% for method in path[1] %}
        {%- if method[0]=="get" or method[0]=="put" or method[0]=="post" or method[0]=="delete" or method[0]=="options" or method[0]=="head" or method[0]=="patch" or method[0]=="trace" %}
        {%- comment %} ================================= Proxy name ============================================= {% endcomment %}
        "{{ pth | replace_first: "/", "" | replace: "/", "_" -}}
            {{- path[0] | replace: "(", "_" | remove: a | remove: ")" | remove: b | remove: d | remove: "-" | replace: c, "_" | downcase -}}
            {% if path[0] == "/" %}root{% endif %}_{{ method[0] }}": {
            {%- comment %} ================================= Proxy description ============================================= {% endcomment %}
            "desc": [
                "{{ method[1].description }}"
            ],
            "matchCondition": {
                "route": "{{ pth }}{{ path[0] }}",
                "methods": [
                    "{{ method[0] | upcase }}"
                ]
            },
            {%- comment %} ================================= Proxy backend url ============================================= {% endcomment %}
            "backendUri": "https://%x-apico-operation-url-
            {%- assign reverse =  path[0] | split: "" | reverse -%}
            {% assign last = reverse[0] -%}
            {%- if method[0]=="get" and last==")" %}read
                {%- elsif method[0]=="get" %}list
                {%- else %}command
            {%- endif %}%",                
            {%- comment %} ================================= Proxy overrides ============================================= {% endcomment %}
            "requestOverrides": {
                "backend.request.headers.x-apico-template-key": "apicobartma-azr-evt-src-fpr-cdb-egd",
                "backend.request.headers.x-apico-template-version": "1.0.0",
                "backend.request.headers.x-apico-api-version": "{{ inf.version }}",
                "backend.request.method": "POST",
                "backend.request.headers.Authorization": "",
                "backend.request.headers.x-apico-request-method": "{request.method}",
                "backend.request.headers.x-apico-request-headers-Authorization": "{request.headers.Authorization}",
                "backend.request.headers.x-apico-request-headers-Host": "{request.headers.Host}",
                "backend.request.headers.x-apico-request-headers-CLIENT-IP": "{request.headers.CLIENT-IP}"            
                "backend.request.headers.x-apico-server-url": "{{ srvs[0].url }}",
                "backend.request.headers.x-apico-path": "{{ path[0] }}",
                "backend.request.headers.x-apico-proxy-route": "{{ path[0] | replace: a, aa | replace: b, bb }}",
                "backend.request.headers.x-apico-operation-id": "{{ method[1].operationId }}"
            }
        }
        {%- if forloop.last == false -%},{% endif -%}
        {% endif -%}
        {% endfor -%}
        {% if forloop.last == false -%},{% endif -%}
        {% endfor %}
    }
}